const CACHE_NAME="berbagi-cerita-v1",API_CACHE="api-cache-v1",IMAGE_CACHE="image-cache-v1",API_URL="https://story-api.dicoding.dev/v1",urlsToCache=["/","/index.html","/app.bundle.js","/manifest.json"],optionalAssets=["/images/icon-192.png","/images/icon-512.png","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"];async function syncPendingStories(){console.log("[SW] Starting background sync...");try{const e=await openDB(),t=e.transaction("pending","readonly").objectStore("pending"),o=await getAllFromStore(t);if(console.log("[SW] Found pending stories:",o.length),0===o.length)return void console.log("[SW] No pending stories to sync");let n=0,a=0;for(const t of o)try{await uploadStory(t);const o=e.transaction("pending","readwrite"),a=o.objectStore("pending");await a.delete(t.id),await waitForTransaction(o),n++,console.log("[SW] Story uploaded successfully:",t.id)}catch(e){a++,console.error("[SW] Upload error for story:",t.id,e)}console.log(`[SW] Sync complete: ${n} success, ${a} failed`),(await self.clients.matchAll()).forEach((e=>{e.postMessage({type:"SYNC_COMPLETE",successCount:n,failCount:a,totalCount:o.length})}))}catch(e){throw console.error("[SW] Sync failed:",e),e}}async function uploadStory(e){console.log("[SW] Uploading story:",e.id);const t=new FormData;if(t.append("description",e.description),t.append("lat",e.lat),t.append("lon",e.lon),e.photo){let o;e.photo instanceof Blob?o=e.photo:"string"==typeof e.photo&&(o=await base64ToBlob(e.photo)),o&&t.append("photo",o,"photo.jpg")}const o=await fetch(`${API_URL}/stories`,{method:"POST",headers:{Authorization:`Bearer ${e.token}`},body:t});if(!o.ok){const e=await o.json();throw new Error(e.message||`Upload failed: ${o.status}`)}return await o.json()}async function base64ToBlob(e){try{if(e.startsWith("data:")){const t=await fetch(e);return await t.blob()}const t=e.split(";base64,"),o=t[0].split(":")[1]||"image/jpeg",n=atob(t[1]),a=n.length,s=new Uint8Array(a);for(let e=0;e<a;++e)s[e]=n.charCodeAt(e);return new Blob([s],{type:o})}catch(e){throw console.error("[SW] base64ToBlob error:",e),e}}function openDB(){return new Promise(((e,t)=>{const o=indexedDB.open("berbagi-cerita-db",1);o.onerror=()=>t(o.error),o.onsuccess=()=>e(o.result),o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("pending")||t.createObjectStore("pending",{keyPath:"id"}),t.objectStoreNames.contains("favorites")||t.createObjectStore("favorites",{keyPath:"id"}),t.objectStoreNames.contains("cached-stories")||t.createObjectStore("cached-stories",{keyPath:"id"})}}))}function getAllFromStore(e){return new Promise(((t,o)=>{const n=e.getAll();n.onsuccess=()=>t(n.result||[]),n.onerror=()=>o(n.error)}))}function waitForTransaction(e){return new Promise(((t,o)=>{e.oncomplete=()=>t(),e.onerror=()=>o(e.error)}))}async function manageImageCache(){try{if("storage"in navigator&&"estimate"in navigator.storage){const{usage:e,quota:t}=await navigator.storage.estimate(),o=e/t*100;if(console.log(`[SW] Cache usage: ${o.toFixed(2)}%`),o>80){console.log("[SW] Cache nearly full, cleaning old images...");const e=await caches.open(IMAGE_CACHE),t=await e.keys(),o=Math.floor(.2*t.length);for(let n=0;n<o;n++)await e.delete(t[n]);console.log(`[SW] Deleted ${o} old images`)}}}catch(e){console.error("[SW] Cache management error:",e)}}self.addEventListener("install",(e=>{console.log("[SW] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[SW] Caching app shell"),e.addAll(urlsToCache).then((()=>(console.log("[SW] Critical assets cached"),Promise.allSettled(optionalAssets.map((t=>e.add(t).catch((e=>{console.warn("[SW] Failed to cache optional asset:",t,e)})))))))).then((()=>{console.log("[SW] Optional assets cached")}))))).then((()=>(console.log("[SW] Install complete, skipping waiting"),self.skipWaiting()))).catch((e=>{console.error("[SW] Install failed:",e)})))})),self.addEventListener("activate",(e=>{console.log("[SW] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME&&e!==API_CACHE&&e!==IMAGE_CACHE)return console.log("[SW] Deleting old cache:",e),caches.delete(e)}))))).then((()=>(console.log("[SW] Activation complete, claiming clients"),self.clients.claim()))))})),self.addEventListener("fetch",(e=>{const{request:t}=e;if(!t.url.startsWith("http"))return;const o=new URL(t.url);o.origin!==new URL(API_URL).origin?"image"===t.destination||/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(o.pathname)?e.respondWith(caches.match(t).then((e=>e?(console.log("[SW] Image from cache:",o.pathname),e):fetch(t).then((e=>{if(e&&e.ok){const n=e.clone();caches.open(IMAGE_CACHE).then((e=>{e.put(t,n),console.log("[SW] Image cached:",o.pathname)}))}return e})).catch((()=>new Response('<svg width="300" height="200" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#f0f0f0"/><text x="50%" y="50%" text-anchor="middle" fill="#999" font-size="16">Offline</text></svg>',{headers:{"Content-Type":"image/svg+xml"}})))))):e.respondWith(caches.match(t).then((e=>e||fetch(t).then((e=>{if(e&&200===e.status&&"error"!==e.type){const o=e.clone();caches.open(CACHE_NAME).then((e=>{e.put(t,o)}))}return e})).catch((e=>(console.log("[SW] Fetch failed:",t.url,e),"document"===t.destination?caches.match("/index.html"):new Response("Offline",{status:503,statusText:"Service Unavailable"}))))))):e.respondWith(fetch(t).then((e=>{if(e&&200===e.status){const o=e.clone();caches.open(API_CACHE).then((e=>{e.put(t,o)}))}return e})).catch((e=>(console.log("[SW] API fetch failed, trying cache:",e),caches.match(t).then((e=>e||new Response(JSON.stringify({error:!0,message:"Offline - data not cached"}),{headers:{"Content-Type":"application/json"}})))))))})),self.addEventListener("sync",(e=>{console.log("[SW] Sync event triggered:",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncPendingStories())})),self.addEventListener("message",(e=>{console.log("[SW] Message received:",e.data),e.data&&"SYNC_NOW"===e.data.type&&e.waitUntil(syncPendingStories().then((()=>{e.ports&&e.ports[0]&&e.ports[0].postMessage({success:!0})})).catch((t=>{e.ports&&e.ports[0]&&e.ports[0].postMessage({success:!1,error:t.message})}))),e.data&&"MANAGE_CACHE"===e.data.type&&e.waitUntil(manageImageCache())})),self.addEventListener("push",(e=>{console.log("[SW] Push notification received");let t={title:"Berbagi Cerita",body:"Ada cerita baru!",icon:"/images/icon-192.png",badge:"/images/icon-96.png",data:{url:"/"}};if(e.data)try{const o=e.data.json();t={title:o.title||t.title,body:o.body||t.body,icon:o.icon||t.icon,badge:o.badge||t.badge,data:{url:o.url||"/",storyId:o.storyId}}}catch(o){console.log("[SW] Using text data:",e.data.text()),t.body=e.data.text()}const o={body:t.body,icon:t.icon,badge:t.badge,data:t.data,actions:[{action:"view",title:"Lihat Cerita"},{action:"close",title:"Tutup"}],vibrate:[200,100,200],tag:"story-notification",requireInteraction:!1};e.waitUntil(self.registration.showNotification(t.title,o))})),self.addEventListener("notificationclick",(e=>{if(console.log("[SW] Notification clicked:",e.action),e.notification.close(),"view"===e.action||!e.action){const t=e.notification.data?.url||"/";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(let o of e)if(o.url===t&&"focus"in o)return o.focus();if(clients.openWindow)return clients.openWindow(t)})))}}));